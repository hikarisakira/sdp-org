---
import { getCollection } from "astro:content";
import BaseHead from "../../components/BaseHead.astro";
import Header from "../../components/Header.astro";
import Footer from "../../components/Footer.astro";
import FormattedDate from "../../components/FormattedDate.astro";
import config from "../../content/config/config.json";

// 取得所有文章
const allPosts = await getCollection("blog");
const sortedPosts = allPosts.sort(
    (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf(),
);

// 統計各分類文章數量
const tagCounts = {
    press: 0,
    events: 0,
    issues: 0,
    clarification: 0,
};

allPosts.forEach((post) => {
    post.data.tags?.forEach((tag) => {
        if (tag in tagCounts) {
            tagCounts[tag as keyof typeof tagCounts]++;
        }
    });
});
---

<!doctype html>
<html lang="zh-TW">
    <head>
        <BaseHead
            title={`最新消息 - ${config.seo.title}`}
            description={config.seo.description}
        />
    </head>
    <body>
        <Header />
        <main class="container mx-auto px-4 py-8">
            <h1 class="text-4xl font-bold mb-8">最新消息</h1>

            <!-- 分類導航 -->
            <div class="tabs tabs-boxed mb-8">
                <a href="/news" class="tab tab-active">全部</a>
                <a href="/news/press" class="tab">新聞稿 ({tagCounts.press})</a>
                <a href="/news/events" class="tab"
                    >活動資訊 ({tagCounts.events})</a
                >
                <a href="/news/issues" class="tab"
                    >議題發言 ({tagCounts.issues})</a
                >
                <a href="/news/clarification" class="tab"
                    >闢謠專區 ({tagCounts.clarification})</a
                >
            </div>

            <!-- 文章列表 -->
            <div class="grid gap-6">
                {
                    sortedPosts.map((post) => (
                        <article class="card bg-base-100 shadow-xl">
                            <div class="card-body">
                                <h2 class="card-title">
                                    <a
                                        href={`/blog/${post.id}`}
                                        class="hover:text-primary"
                                    >
                                        {post.data.title}
                                    </a>
                                </h2>
                                <p class="text-sm text-gray-500">
                                    <FormattedDate date={post.data.pubDate} />
                                </p>
                                {post.data.tags &&
                                    post.data.tags.length > 0 && (
                                        <div class="flex gap-2 flex-wrap">
                                            {post.data.tags.map(
                                                (tag: string) => (
                                                    <span class="badge badge-primary badge-sm">
                                                        {tag}
                                                    </span>
                                                ),
                                            )}
                                        </div>
                                    )}
                                {post.data.description && (
                                    <p class="text-gray-700">
                                        {post.data.description}
                                    </p>
                                )}
                                <div class="card-actions justify-end">
                                    <a
                                        href={`/blog/${post.id}`}
                                        class="btn btn-primary btn-sm"
                                    >
                                        閱讀更多
                                    </a>
                                </div>
                            </div>
                        </article>
                    ))
                }
            </div>
        </main>
        <Footer />
    </body>
</html>
