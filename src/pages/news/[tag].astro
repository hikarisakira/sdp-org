---
import { getCollection } from "astro:content";
import BaseHead from "../../components/BaseHead.astro";
import Header from "../../components/Header.astro";
import Footer from "../../components/Footer.astro";
import FormattedDate from "../../components/FormattedDate.astro";
import config from "../../content/config/config.json";

const tagMap: Record<string, string> = {
    press: "æ–°èç¨¿",
    events: "æ´»å‹•è³‡è¨Š",
    issues: "è­°é¡Œç™¼è¨€",
    clarification: "é—¢è¬ å°ˆå€",
};

export async function getStaticPaths() {
    const tags = ["press", "events", "issues", "clarification"];

    return tags.map((tag) => ({
        params: { tag },
    }));
}

const tag = Astro.params.tag as string;
const allPosts = await getCollection("news");

const filteredPosts = allPosts
    .filter((post) => {
        if (
            !post.data.tags ||
            !Array.isArray(post.data.tags) ||
            post.data.tags.length === 0
        ) {
            return false;
        }
        return post.data.tags.includes(tag);
    })
    .sort((a, b) => {
        const dateA = a.data.pubDate ? new Date(a.data.pubDate).valueOf() : 0;
        const dateB = b.data.pubDate ? new Date(b.data.pubDate).valueOf() : 0;
        return dateB - dateA;
    });

const pageTitle: string = tagMap[tag] || tag;
---

<!doctype html>
<html lang="zh-TW">
    <head>
        <BaseHead
            title={`${pageTitle} - ${config.seo.title}`}
            description={config.seo.description}
        />
    </head>
    <body>
        <Header />
        <main class="container mx-auto px-4 py-8">
            <h1 class="text-4xl font-bold mb-8">{pageTitle}</h1>

            {
                import.meta.env.DEV && (
                    <div class="alert alert-info mb-4">
                        <div>
                            <p>ğŸ” åµéŒ¯è³‡è¨Š</p>
                            <p>ç•¶å‰æ¨™ç±¤: {tag}</p>
                            <p>æ‰¾åˆ°æ–‡ç« æ•¸: {filteredPosts.length}</p>
                            <p>ç¸½æ–‡ç« æ•¸: {allPosts.length}</p>
                        </div>
                    </div>
                )
            }

            <!-- â­ æ›´æ–°ï¼štag è·¯ç”±ç¾åœ¨æ˜¯ /news/tag/xxx -->
            <div class="tabs tabs-boxed mb-8">
                <a href="/news" class="tab">å…¨éƒ¨</a>
                <a
                    href="/news/tag/press"
                    class={`tab ${tag === "press" ? "tab-active" : ""}`}
                    >æ–°èç¨¿</a
                >
                <a
                    href="/news/tag/events"
                    class={`tab ${tag === "events" ? "tab-active" : ""}`}
                    >æ´»å‹•è³‡è¨Š</a
                >
                <a
                    href="/news/tag/issues"
                    class={`tab ${tag === "issues" ? "tab-active" : ""}`}
                    >è­°é¡Œç™¼è¨€</a
                >
                <a
                    href="/news/tag/clarification"
                    class={`tab ${tag === "clarification" ? "tab-active" : ""}`}
                    >é—¢è¬ å°ˆå€</a
                >
            </div>

            <div class="grid gap-6">
                {
                    filteredPosts.length === 0 ? (
                        <div class="alert alert-warning">
                            <span>ç›®å‰æ²’æœ‰ã€Œ{pageTitle}ã€åˆ†é¡çš„æ–‡ç« </span>
                        </div>
                    ) : (
                        filteredPosts.map((post) => (
                            <article class="card bg-base-100 shadow-xl">
                                <div class="card-body">
                                    <h2 class="card-title">
                                        <a
                                            href={`/news/${post.id}`}
                                            class="hover:text-primary"
                                        >
                                            {post.data.title || "ç„¡æ¨™é¡Œ"}
                                        </a>
                                    </h2>
                                    {post.data.pubDate && (
                                        <p class="text-sm text-gray-500">
                                            <FormattedDate
                                                date={post.data.pubDate}
                                            />
                                        </p>
                                    )}
                                    {post.data.description && (
                                        <p class="text-gray-700">
                                            {post.data.description}
                                        </p>
                                    )}
                                    {post.data.tags &&
                                        post.data.tags.length > 0 && (
                                            <div class="flex gap-2 flex-wrap mt-2">
                                                {post.data.tags.map(
                                                    (postTag: string) => (
                                                        <span class="badge badge-primary badge-sm">
                                                            {tagMap[postTag] ||
                                                                postTag}
                                                        </span>
                                                    ),
                                                )}
                                            </div>
                                        )}
                                    <div class="card-actions justify-end mt-4">
                                        <a
                                            href={`/news/${post.id}`}
                                            class="btn btn-primary btn-sm"
                                        >
                                            é–±è®€æ›´å¤š
                                        </a>
                                    </div>
                                </div>
                            </article>
                        ))
                    )
                }
            </div>
        </main>
        <Footer />
    </body>
</html>
