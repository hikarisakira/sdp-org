---
// src/pages/category/[...category].astro
import { getCollection } from "astro:content";
import { CATEGORIES } from "@/data/categories";
import Layout from "@/layouts/Layout";

export async function getStaticPaths() {
    const allPosts = await getCollection("news");

    // 為每個分類生成靜態路徑
    return CATEGORIES.map((category) => {
        const filteredPosts = allPosts.filter(
            (post) => post.data.category === category,
        );

        // 按日期排序
        const sortedPosts = filteredPosts.sort((a, b) => {
            const dateA = a.data.pubDate instanceof Date ? a.data.pubDate : new Date(a.data.pubDate);
            const dateB = b.data.pubDate instanceof Date ? b.data.pubDate : new Date(b.data.pubDate);
            return dateB.getTime() - dateA.getTime();
        });

        return {
            params: { category },
            props: {
                category,
                posts: sortedPosts,
            },
        };
    });
}

interface Props {
    category: string;
    posts: any[];
}

const { category, posts } = Astro.props;

// 分類標籤映射（繁體中文）
const categoryLabels: Record<string, string> = {
    press: "新聞稿",
    events: "活動資訊",
    issues: "議題發言",
    clarification: "闢謠專區",
};

const categoryLabel = categoryLabels[category] || category;
---

<Layout
    title={categoryLabel}
    description={`瀏覽分類：${categoryLabel} 的所有文章`}
>
    <div class="container mx-auto">
        <h1 class="text-4xl font-bold mb-8">{categoryLabel}</h1>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {
                posts.map((post) => (
                    <article class="card bg-base-100 shadow-xl">
                        {post.data.heroImage && (
                            <figure>
                                <img
                                    src={post.data.heroImage}
                                    alt={post.data.title}
                                    class="w-full h-48 object-cover"
                                />
                            </figure>
                        )}
                        <div class="card-body">
                            <h2 class="card-title">{post.data.title}</h2>
                            <p class="text-gray-600 line-clamp-2">{post.data.description}</p>
                            <div class="text-sm text-gray-500">
                                {post.data.pubDate && (
                                    <time datetime={post.data.pubDate instanceof Date
                                        ? post.data.pubDate.toISOString()
                                        : new Date(post.data.pubDate).toISOString()}>
                                        {(post.data.pubDate instanceof Date
                                            ? post.data.pubDate
                                            : new Date(post.data.pubDate)
                                        ).toLocaleDateString("zh-TW", {
                                            year: "numeric",
                                            month: "long",
                                            day: "numeric",
                                        })}
                                    </time>
                                )}
                            </div>
                            <div class="card-actions justify-end mt-4">
                                <a
                                    href={`/news/${post.id}`}
                                    class="btn btn-primary btn-sm"
                                >
                                    閱讀更多
                                </a>
                            </div>
                        </div>
                    </article>
                ))
            }
        </div>

        {
            posts.length === 0 && (
                <div class="text-center py-12">
                    <p class="text-xl text-gray-500">此分類目前沒有文章</p>
                </div>
            )
        }
    </div>
</Layout>
