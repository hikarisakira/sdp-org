---
import BaseHead from "../components/BaseHead.astro";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import config from "../content/config/config.json";
import HeroCarousel from "../components/index/HeroCarousel/HeroCarousel.astro";
import LatestNews from "@/components/index/NewsBlock/news";
import MissionStatement from "@/components/index/MissionStatement/MissionStatement.svelte";
import CoreValues from "@/components/index/CoreValues/CoreValues.svelte";
import ActionCTA from "@/components/index/ActionCTA/ActionCTA.svelte";
import { getCollection } from "astro:content";

// 從 TinaCMS 載入資料
const pageData = await import("../content/carousel/homeCarousel.json");

// 提取第一個 heroCarousel block
const carouselBlock = pageData.blocks?.find(
  (block: any) => block._template === "heroCarousel"
);

// 轉換資料格式以符合 HeroCarousel 元件的期望
const slides =
  carouselBlock?.slides?.map((slide: any) => ({
    title: slide.title,
    description: slide.subtitle,
    image: slide.image,
    buttonText: slide.showButton ? slide.buttonText : undefined,
    buttonLink: slide.showButton ? slide.buttonLink : undefined,
  })) || [];

const autoplay = carouselBlock?.autoplay ?? true;
const autoplayDelay = carouselBlock?.delay ?? 5000;

// 取得最新消息
const allPosts = await getCollection("news");

// 按發布日期排序（最新的在前）
const sortedPosts = allPosts.sort((a, b) => {
  const dateA =
    a.data.pubDate instanceof Date ? a.data.pubDate : new Date(a.data.pubDate);
  const dateB =
    b.data.pubDate instanceof Date ? b.data.pubDate : new Date(b.data.pubDate);
  return dateB.getTime() - dateA.getTime();
});

// 準備傳給 React 元件的資料
const latestPosts = sortedPosts.slice(0, 6).map((post) => ({
  id: post.id,
  data: {
    title: post.data.title,
    description: post.data.description,
    pubDate: post.data.pubDate,
    heroImage: post.data.heroImage,
    category: post.data.category,
    tags: post.data.tags || [],
  },
}));
---

<!doctype html>
<html lang="zh-TW">
  <head>
    <BaseHead title={config.seo.title} description={config.seo.description} />
  </head>
  <body>
    <Header />
    {
      slides.length > 0 ? (
        <HeroCarousel
          slides={slides}
          autoplay={autoplay}
          autoplayDelay={autoplayDelay}
        />
      ) : (
        <div class="no-content">
          <p>請在 TinaCMS 中添加輪播內容</p>
        </div>
      )
    }
    <MissionStatement client:visible />
    <LatestNews posts={latestPosts} client:visible />
    <CoreValues client:visible />
    <ActionCTA client:visible />
    <Footer />
  </body>
</html>
